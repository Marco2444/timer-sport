<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timer Sport</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#111">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.container {
    width: 100%;
    max-width: 420px;
    padding: 20px;
    text-align: center;
}
.timer {
    font-size: 80px;
    font-weight: bold;
}
.sub {
    color: #aaa;
    margin: 8px 0;
}
.round {
    font-size: 18px;
    color: #0a84ff;
    margin-bottom: 10px;
}

.buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
button {
    flex: 1;
    padding: 16px 8px;
    font-size: 20px;
    border: none;
    border-radius: 14px;
    background: #333;
    color: white;
    white-space: normal;
}
button.active {
    background: #007aff;
}

.start {
    background: #34c759;
    font-size: 24px;
    padding: 16px;
    border-radius: 16px;
    width: 80%;
    margin: 15px auto 0;
    display: block;
}

#pauseControls {
    justify-content: center;
}
#pauseControls button {
    background: #ff9500;
    width: 40%;
}

/* MODAL */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
}
.modalContent {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
    width: 90%;
    max-width: 320px;
    text-align: center;
}
.modalContent h3 {
    margin-top: 0;
}
.picker {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
}
select {
    background: #111;
    color: white;
    font-size: 28px;
    border: none;
    height: 120px;
    width: 80px;
    text-align: center;
    -webkit-appearance: none;
}
</style>
</head>

<body>
<div class="container">

<div class="sub" id="status">Mode SIMPLE</div>
<div class="timer" id="timer">02:00</div>
<div class="round" id="roundInfo"></div>

<div class="buttons" id="simpleBtns">
    <button onclick="setSimple(this,60)">1<br>:00</button>
    <button onclick="setSimple(this,90)">1<br>:30</button>
    <button onclick="setSimple(this,120)" class="active">2<br>:00</button>
    <button onclick="setSimple(this,150)">2<br>:30</button>
    <button onclick="setSimple(this,180)">3<br>:00</button>
</div>

<div class="buttons">
    <button onclick="custom()">Custom</button>
    <button onclick="interval()">Interval</button>
    <button onclick="emom()">EMOM</button>
</div>

<button class="start" id="startBtn" onclick="start()">Démarrer</button>

<div class="buttons" id="pauseControls" style="display:none;">
    <button onclick="resume()">Reprendre</button>
    <button onclick="cancel()">Annuler</button>
</div>

</div>

<!-- PICKER -->
<div class="modal" id="picker">
<div class="modalContent">
    <h3 id="pickerTitle"></h3>
    <div class="picker">
        <select id="min"></select>
        <span>:</span>
        <select id="sec"></select>
    </div>
    <div class="buttons">
        <button onclick="closePicker()">Annuler</button>
        <button onclick="validatePicker()">OK</button>
    </div>
</div>
</div>

<script>
let mode="SIMPLE";
let duration=120, remaining=120;
let timer=null, endTime=null;
let phase="WORK";
let round=1, maxRounds=1;
let audio=null, cb=null;

const timerEl=timer;
const roundInfo=document.getElementById("roundInfo");

function update(){
    const m=Math.floor(remaining/60);
    const s=remaining%60;
    document.getElementById("timer").textContent =
        `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function beep(f,d){
    if(!audio) audio=new AudioContext();
    const o=audio.createOscillator(), g=audio.createGain();
    o.frequency.value=f; g.gain.value=0.15;
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime+d);
}
function vibrate(p){ navigator.vibrate && navigator.vibrate(p); }

/* SIMPLE */
function setSimple(btn,sec){
    if(timer) return;
    mode="SIMPLE";
    duration=remaining=sec;
    status.textContent="Mode SIMPLE";
    roundInfo.textContent="";
    document.querySelectorAll("#simpleBtns button")
        .forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    update();
}

/* CUSTOM */
function custom(){
    openPicker("Temps personnalisé",duration,v=>{
        duration=remaining=v;
        update();
    });
}

/* INTERVAL */
let on=30, off=15;
function interval(){
    mode="INTERVAL";
    openPicker("Temps ON",on,v=>{
        on=v;
        openPicker("Temps OFF",off,v2=>{
            off=v2;
            openPicker("Nombre de tours",maxRounds*60,v3=>{
                maxRounds=Math.max(1,Math.floor(v3/60));
                round=1;
                phase="WORK";
                remaining=on;
                status.textContent="INTERVAL";
                roundInfo.textContent=`Tour ${round}/${maxRounds}`;
                update();
            });
        });
    });
}

/* EMOM */
let work=40, rest=20;
function emom(){
    mode="EMOM";
    openPicker("Durée EMOM (min)",maxRounds*60,v=>{
        maxRounds=Math.floor(v/60);
        openPicker("Temps effort",work,w=>{
            work=w;
            openPicker("Temps repos",rest,r=>{
                rest=r;
                round=1;
                phase="WORK";
                remaining=work;
                status.textContent="EMOM";
                roundInfo.textContent=`EMOM ${round}/${maxRounds}`;
                update();
            });
        });
    });
}

/* TIMER */
function start(){
    endTime=Date.now()+remaining*1000;
    startBtn.textContent="Pause";
    startBtn.onclick=pause;
    timer=setInterval(tick,500);
}

function tick(){
    remaining=Math.max(0,Math.ceil((endTime-Date.now())/1000));
    update();
    if(remaining>0) return;

    if(mode==="INTERVAL"){
        if(phase==="WORK"){ phase="REST"; remaining=off; }
        else {
            round++;
            if(round>maxRounds) return end();
            phase="WORK"; remaining=on;
        }
        roundInfo.textContent=`Tour ${round}/${maxRounds}`;
    }

    if(mode==="EMOM"){
        if(phase==="WORK"){ phase="REST"; remaining=rest; }
        else {
            round++;
            if(round>maxRounds) return end();
            phase="WORK"; remaining=work;
        }
        roundInfo.textContent=`EMOM ${round}/${maxRounds}`;
    }

    endTime=Date.now()+remaining*1000;
    beep(1200,.25);
    vibrate(200);
}

function pause(){
    clearInterval(timer); timer=null;
    pauseControls.style.display="flex";
    startBtn.style.display="none";
}

function resume(){
    endTime=Date.now()+remaining*1000;
    pauseControls.style.display="none";
    startBtn.style.display="block";
    timer=setInterval(tick,500);
}

function cancel(){
    clearInterval(timer); timer=null;
    remaining=duration;
    roundInfo.textContent="";
    update();
    pauseControls.style.display="none";
    startBtn.style.display="block";
    startBtn.textContent="Démarrer";
    startBtn.onclick=start;
}

function end(){
    clearInterval(timer); timer=null;
    beep(1500,.5);
    vibrate([300,150,300]);
    startBtn.textContent="Démarrer";
    startBtn.onclick=start;
}

/* PICKER */
function openPicker(title,val,callback){
    cb=callback;
    pickerTitle.textContent=title;
    fill(min,0,59,Math.floor(val/60));
    fill(sec,0,59,val%60);
    picker.style.display="flex";
}
function fill(sel,a,b,v){
    sel.innerHTML="";
    for(let i=a;i<=b;i++){
        const o=document.createElement("option");
        o.value=i; o.textContent=String(i).padStart(2,"0");
        if(i===v) o.selected=true;
        sel.appendChild(o);
    }
}
function validatePicker(){
    picker.style.display="none";
    cb(parseInt(min.value)*60+parseInt(sec.value));
}
function closePicker(){ picker.style.display="none"; }
</script>
</body>
</html>
