<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timer Sport</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#111">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.container {
    width: 100%;
    max-width: 420px;
    padding: 20px;
    text-align: center;
}
.timer {
    font-size: 80px;
    font-weight: bold;
}
.sub {
    color: #aaa;
    margin: 8px 0;
}
.round {
    font-size: 18px;
    color: #0a84ff;
    margin-bottom: 10px;
}

.buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}
button {
    flex: 1;
    padding: 16px;
    font-size: 18px;
    border: none;
    border-radius: 14px;
    background: #333;
    color: white;
}
button.active {
    background: #007aff;
}

.start {
    background: #34c759;
    font-size: 24px;
    padding: 16px;
    border-radius: 16px;
    width: 80%;
    margin: 15px auto 0;
    display: block;
}

#pauseControls {
    justify-content: center;
}
#pauseControls button {
    background: #ff9500;
    width: 40%;
}

/* MODAL */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
}
.modalContent {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
    width: 90%;
    max-width: 320px;
    text-align: center;
}
.picker {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
}
select {
    background: #111;
    color: white;
    font-size: 28px;
    border: none;
    height: 120px;
    width: 80px;
    text-align: center;
    -webkit-appearance: none;
}
</style>
</head>

<body>
<div class="container">

<div class="sub" id="status">Mode SIMPLE</div>
<div class="timer" id="timer">02:00</div>
<div class="round" id="roundInfo"></div>

<div class="buttons">
    <button onclick="setSimple(this,60)">1:00</button>
    <button onclick="setSimple(this,90)">1:30</button>
    <button onclick="setSimple(this,120)" class="active">2:00</button>
</div>
<div class="buttons">
    <button onclick="setSimple(this,150)">2:30</button>
    <button onclick="setSimple(this,180)">3:00</button>
</div>

<div class="buttons">
    <button onclick="custom(this)">Custom</button>
    <button onclick="interval(this)">Interval</button>
    <button onclick="emom(this)">EMOM</button>
</div>

<button class="start" id="startBtn" onclick="start()">Démarrer</button>

<div class="buttons" id="pauseControls" style="display:none;">
    <button onclick="resume()">Reprendre</button>
    <button onclick="cancel()">Annuler</button>
</div>

</div>

<!-- PICKER -->
<div class="modal" id="picker">
<div class="modalContent">
    <h3 id="pickerTitle"></h3>
    <div class="picker" id="timePicker">
        <select id="min"></select>
        <span>:</span>
        <select id="sec"></select>
    </div>
    <div class="picker" id="numberPicker" style="display:none;">
        <select id="number"></select>
    </div>
    <div class="buttons">
        <button onclick="closePicker()">Annuler</button>
        <button onclick="validatePicker()">OK</button>
    </div>
</div>
</div>

<script>
let mode="SIMPLE";
let duration=120, remaining=120;
let timerInterval=null, endTime=null;
let phase="WORK";
let round=1, maxRounds=1;
let audio=null, cb=null;

const timerEl=document.getElementById("timer");
const roundInfo=document.getElementById("roundInfo");

/* DISPLAY */
function update(){
    const m=Math.floor(remaining/60);
    const s=remaining%60;
    timerEl.textContent =
        `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* AUDIO */
function ensureAudio(){
    if(!audio) audio=new (window.AudioContext||window.webkitAudioContext)();
    if(audio.state==="suspended") audio.resume();
}
function beep(freq,dur){
    ensureAudio();
    const o=audio.createOscillator(), g=audio.createGain();
    o.frequency.value=freq;
    g.gain.value=0.2;
    o.connect(g);
    g.connect(audio.destination);
    o.start();
    o.stop(audio.currentTime+dur);
}

/* ACTIVE */
function setActive(btn){
    document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
}

/* SIMPLE */
function setSimple(btn,sec){
    if(timerInterval) return;
    mode="SIMPLE";
    setActive(btn);
    duration=remaining=sec;
    roundInfo.textContent="";
    update();
}

/* CUSTOM */
function custom(btn){
    setActive(btn);
    openTimePicker("Temps personnalisé",duration,v=>{
        duration=remaining=v;
        update();
    });
}

/* INTERVAL */
let on=30, off=15;
function interval(btn){
    setActive(btn);
    mode="INTERVAL";
    openTimePicker("Temps ON",on,v=>{
        on=v;
        openTimePicker("Temps OFF",off,v2=>{
            off=v2;
            openNumberPicker("Nombre de tours",1,50,v3=>{
                maxRounds=v3;
                round=1;
                phase="WORK";
                remaining=on;
                roundInfo.textContent=`${round}/${maxRounds}`;
                update();
            });
        });
    });
}

/* EMOM */
let work=40, rest=20;
function emom(btn){
    setActive(btn);
    mode="EMOM";
    openNumberPicker("Durée EMOM (minutes)",1,60,v=>{
        maxRounds=v;
        openTimePicker("Temps effort",work,w=>{
            work=w;
            openTimePicker("Temps repos",rest,r=>{
                rest=r;
                round=1;
                phase="WORK";
                remaining=work;
                roundInfo.textContent=`${round}/${maxRounds}`;
                update();
            });
        });
    });
}

/* TIMER */
function start(){
    endTime=Date.now()+remaining*1000;
    startBtn.textContent="Pause";
    startBtn.onclick=pause;
    timerInterval=setInterval(tick,250);
}
function tick(){
    remaining=Math.max(0,Math.ceil((endTime-Date.now())/1000));
    update();
    if(remaining>0) return;

    if(mode==="INTERVAL"||mode==="EMOM"){
        if(phase==="WORK"){
            phase="REST";
            remaining=mode==="INTERVAL"?off:rest;
            beep(600,0.15);
        } else {
            round++;
            if(round>maxRounds) return end();
            phase="WORK";
            remaining=mode==="INTERVAL"?on:work;
            beep(1200,0.15);
        }
        roundInfo.textContent=`${round}/${maxRounds}`;
        endTime=Date.now()+remaining*1000;
        return;
    }
    end();
}
function pause(){
    clearInterval(timerInterval);
    timerInterval=null;
    pauseControls.style.display="flex";
    startBtn.style.display="none";
}
function resume(){
    endTime=Date.now()+remaining*1000;
    pauseControls.style.display="none";
    startBtn.style.display="block";
    timerInterval=setInterval(tick,250);
}
function cancel(){
    clearInterval(timerInterval);
    timerInterval=null;
    remaining=duration;
    roundInfo.textContent="";
    update();
    pauseControls.style.display="none";
    startBtn.style.display="block";
    startBtn.textContent="Démarrer";
    startBtn.onclick=start;
}
function end(){
    clearInterval(timerInterval);
    timerInterval=null;
    beep(1600,0.08); // bip final court
    startBtn.textContent="Démarrer";
    startBtn.onclick=start;
}

/* PICKERS */
function openTimePicker(title,val,callback){
    cb=callback;
    pickerTitle.textContent=title;
    timePicker.style.display="flex";
    numberPicker.style.display="none";
    fill(min,0,59,Math.floor(val/60));
    fill(sec,0,59,val%60);
    picker.style.display="flex";
}
function openNumberPicker(title,minV,maxV,callback){
    cb=callback;
    pickerTitle.textContent=title;
    timePicker.style.display="none";
    numberPicker.style.display="flex";
    number.innerHTML="";
    for(let i=minV;i<=maxV;i++){
        const o=document.createElement("option");
        o.value=i;
        o.textContent=i;
        number.appendChild(o);
    }
    picker.style.display="flex";
}
function fill(sel,a,b,v){
    sel.innerHTML="";
    for(let i=a;i<=b;i++){
        const o=document.createElement("option");
        o.value=i;
        o.textContent=String(i).padStart(2,"0");
        if(i===v) o.selected=true;
        sel.appendChild(o);
    }
}
function validatePicker(){
    picker.style.display="none";
    if(numberPicker.style.display==="flex") cb(parseInt(number.value));
    else cb(parseInt(min.value)*60+parseInt(sec.value));
}
function closePicker(){ picker.style.display="none"; }

update();
</script>
</body>
</html>
