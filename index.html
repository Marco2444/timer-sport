<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timer Sport</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.container {
    text-align: center;
    width: 100%;
    max-width: 400px;
    padding: 20px;
}

.series {
    color: #aaa;
    font-size: 20px;
    margin-bottom: 10px;
}

.timer {
    font-size: 80px;
    font-weight: bold;
    margin: 20px 0;
}

.buttons {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.buttons button {
    flex: 1;
    margin: 0 5px;
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    background: #333;
    color: white;
}

.buttons button.active {
    background: #007aff;
}

.start {
    width: 100%;
    padding: 15px;
    font-size: 22px;
    border: none;
    border-radius: 15px;
    background: #34c759;
    color: white;
}

#pauseControls button {
    background: #ff9500;
}
</style>
</head>

<body>
<div class="container">

    <div class="series">Série <span id="series">0</span></div>

    <div class="timer" id="timer">02:00</div>

    <div class="buttons">
        <button onclick="setDuration(60)">1:00</button>
        <button onclick="setDuration(90)">1:30</button>
        <button onclick="setDuration(120)" class="active">2:00</button>
        <button onclick="setDuration(180)">3:00</button>
    </div>

    <button class="start" id="startBtn" onclick="startTimer()">Démarrer</button>

    <div class="buttons" id="pauseControls" style="display:none;">
        <button onclick="resumeTimer()">Reprendre</button>
        <button onclick="cancelTimer()">Annuler</button>
    </div>

</div>

<script>
let selectedDuration = 120;
let remainingTime = 120;
let timer = null;
let series = 0;
let isPaused = false;
let wakeLock = null;
let audioCtx = null;

/* ===== Empêcher veille ===== */
async function keepScreenOn() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
        } catch {}
    }
}

function releaseScreen() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
}

/* ===== Durée ===== */
function setDuration(seconds) {
    if (timer || isPaused) return;

    selectedDuration = seconds;
    remainingTime = seconds;
    updateDisplay();

    document.querySelectorAll('.buttons button')
        .forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

/* ===== Timer ===== */
function startTimer() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    remainingTime = selectedDuration;
    updateDisplay();

    series++;
    document.getElementById("series").textContent = series;

    keepScreenOn();

    document.getElementById("startBtn").textContent = "Pause";
    document.getElementById("startBtn").onclick = pauseTimer;

    timer = setInterval(tick, 1000);
}

function tick() {
    if (remainingTime > 0) {
        remainingTime--;
        updateDisplay();
    } else {
        endTimer();
    }
}

function pauseTimer() {
    clearInterval(timer);
    timer = null;
    isPaused = true;

    document.getElementById("startBtn").style.display = "none";
    document.getElementById("pauseControls").style.display = "flex";
}

function resumeTimer() {
    isPaused = false;

    document.getElementById("pauseControls").style.display = "none";
    document.getElementById("startBtn").style.display = "block";
    document.getElementById("startBtn").textContent = "Pause";
    document.getElementById("startBtn").onclick = pauseTimer;

    timer = setInterval(tick, 1000);
}

function cancelTimer() {
    clearInterval(timer);
    timer = null;
    isPaused = false;

    remainingTime = selectedDuration;
    updateDisplay();

    document.getElementById("pauseControls").style.display = "none";
    document.getElementById("startBtn").style.display = "block";
    document.getElementById("startBtn").textContent = "Démarrer";
    document.getElementById("startBtn").onclick = startTimer;

    releaseScreen();
}

function endTimer() {
    clearInterval(timer);
    timer = null;

    document.getElementById("startBtn").textContent = "Démarrer";
    document.getElementById("startBtn").onclick = startTimer;

    releaseScreen();
    playFeedback();
}

/* ===== Affichage ===== */
function updateDisplay() {
    const min = Math.floor(remainingTime / 60);
    const sec = remainingTime % 60;
    document.getElementById("timer").textContent =
        String(min).padStart(2, '0') + ":" + String(sec).padStart(2, '0');
}

/* ===== Son + vibration ===== */
function playFeedback() {
    if (audioCtx) {
        for (let i = 0; i < 3; i++) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.frequency.value = 1000;
            gain.gain.value = 0.2;

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const start = audioCtx.currentTime + i * 0.4;
            osc.start(start);
            osc.stop(start + 0.25);
        }
    }

    if (navigator.vibrate) {
        navigator.vibrate([300, 150, 300, 150, 300]);
    }
}

/* ===== PWA ===== */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
